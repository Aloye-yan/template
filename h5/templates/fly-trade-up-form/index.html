<div class="fly-trade-up-form-h5">
  <div class="form-content step-wrapper">
      <div class="head">
          <div class="title">[i18]tradeup.step.step[/i18] 1</div>
          <img alt="" class="icon"
               src="https://static-ussite.tineco.com/%E7%94%BB%E6%9D%BF%2010.png_f0e9b357-6.png">
      </div>
      <div class="body">
          <div class="title">[i18]tradeup.form_wrapper.title[/i18]</div>
          <div class="input-group">
              <input class="z-input" name="name" placeholder="[i18]tradeup.form_wrapper.name[/i18]*" type="text">
          </div>
          <div class="input-group">
              <input class="z-input"
                     name="email" placeholder="[i18]tradeup.form_wrapper.email[/i18]"
                     type="text">
          </div>
          <div class="input-group">
              <div class="down-menu">
                  <input class="z-input dis-none" name="country">
                  <div class="text my-choose placeholder">[i18]tradeup.form_wrapper.country[/i18]*</div>
                  <ul class="down-list close-set">
                      <li>
                          <img alt=""
                               src="https://static-ussite.tineco.com/c745081f-3c8e-4866-a876-fa2de1caef86.jpg">
                          <div class="text">United States</div>
                      </li>
                      <li><img alt=""
                               src="https://static-ussite.tineco.com/b489963d-7a8c-4c8d-a709-11d9b600602d.jpg">
                          <div class="text">Deutschland</div>
                      </li>
                      <li><img alt="" src="https://static-ussite.tineco.com/13a0d533-5a9e-4403-aa84-23b9017bb5e6.jpg">
                          <div class="text">France</div>
                      </li>
                      <li><img alt="" src="https://static-ussite.tineco.com/1d9d2cba-1d1c-41aa-abdc-4a0899cb2a5f.jpg">
                          <div class="text">Italia</div>
                      </li>
                      <li><img alt="" src="https://static-ussite.tineco.com/ea53a366-8d06-4e58-bba6-e58d4a09e928.jpg">
                          <div class="text">España</div>
                      </li>
                      <li><img alt=""
                               class="other"
                               src="https://static-ussite.tineco.com/2e0f158c-8e84-435a-8c86-0bc89c66550d.svg_91e75cf1-d.svg">
                          <div class="text">[i18]tradeup.form_wrapper.otherCountry[/i18]</div>
                      </li>
                  </ul>
              </div>
          </div>
          <div class="input-group">
              <input class="z-input" name="brand" placeholder="[i18]tradeup.form_wrapper.brand_old_cleaner[/i18]*" type="text">
          </div>
          <div class="input-group">
              <input class="z-input" name="price" placeholder="[i18]tradeup.form_wrapper.price_old_cleaner[/i18]*" type="text">
          </div>
          <div class="desc">
              *[i18]tradeup.form_wrapper.desc[/i18]<span class="showPop"> *[i18]tradeup.form_wrapper.reference[/i18] <div class="question">?</div></span>
          
          </div>
          <div class="input-group">
              <div class="img-area">
                  <div class="img-box">
                  </div>
                  <!--上传图片或文件-->
                  <div class="fly-upload">
                      <div class="content">+</div>
                      <input class="f-input" name="contentId" type="file"/>
                  </div>
              </div>
              <div class="img-tips">*[i18]tradeup.form_wrapper.imgtips[/i18]</div>
          </div>
      </div>
      <div class="foot">
          <div class="submitBtn">[i18]tradeup.form_wrapper.imgtips[/i18]</div>
      </div>
  </div>
  <div class="success-tips">
      <div class="form-success">
          <img alt="" src="https://static-ussite.tineco.com/%E7%94%BB%E6%9D%BF%2019.png_a1648496-4.png">
          <div class="text">[i18]tradeup.form_wrapper.succtip[/i18]</div>
      </div>
  </div>
  <div class="fly-error-tip">
      <div class="fly-err-msg">
          <img alt="" src="https://static-ussite.tineco.com/%E7%94%BB%E6%9D%BF%2018.png_848026a1-1.png">
          <div class="text"></div>
      </div>
  </div>
  <div class="upload-animation hide">
      <div class="fly-loading"></div>
  </div>
</div>
<script>
$(function () {
  $(".fly-trade-up-form-h5 .down-menu").click(function () {
    event.stopPropagation()
    $(this).find(".down-list").toggleClass("close-set")
  })
  $(".fly-trade-up-form-h5 .down-list li").click(function () {
    event.stopPropagation()
    $(this).parent().parent().find(".my-choose").text($(this).children(".text").text())
    $(this).parent().addClass("close-set")
    $('.my-choose').removeClass('placeholder')
  })
  $(document).click(function () {
    $(".fly-trade-up-form-h5 .down-list").addClass("close-set")
  })
  const baseUrl = "us-test.tineco.com"
  //提交表单的参数
  const formParams = {
    name: "",
    email: "",
    country: "",
    brand: "",
    price: "",
    contentId: "",
    status: 0,
    domain: baseUrl
  }

  const imgArrStr = [] //图片数组字符串

  const resetFormParams = function () {
    //数据清空
    formParams.name = ""
    formParams.email = ""
    formParams.country = ""
    formParams.brand = ""
    formParams.price = ""
    formParams.contentId = ""
    formParams.status = 0
    formParams.domain = baseUrl
    //视图清空
    $("input[name='name']").val("")
    $("input[name='email']").val("")
    $(".down-menu .my-choose").text("[i18]tradeup.form_wrapper.country[/i18]*")
    $(".down-menu .my-choose").addClass('placeholder')
    $("input[name='brand']").val("")
    $("input[name='price']").val("")
    $(".img-box").html("")
  }
  //表单字段验证
  const fromRequired = {
    name: [{
      required: true,
      msg: "[i18]tradeup.form_wrapper.name[/i18] [i18]tradeup.form_wrapper.required[/i18]!"
    }],
    email: [{
      required: true,
      msg: "[i18]tradeup.form_wrapper.emails[/i18] [i18]tradeup.form_wrapper.required[/i18]!"
    }, {
      validate: function (val) {
        return /^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/.test(val)
      },
      msg: "[i18]tradeup.form_wrapper.emails[/i18] [i18]tradeup.form_wrapper.invalide[/i18]"
    }],
    country: [{
      required: true,
      msg: "[i18]tradeup.form_wrapper.country[/i18] [i18]tradeup.form_wrapper.required[/i18]!"
    }],
    brand: [{
      required: true,
      msg: "[i18]tradeup.form_wrapper.brand_old_cleaner[/i18] [i18]tradeup.form_wrapper.required[/i18]!"
    }],
    price: [{
      required: true,
      msg: "[i18]tradeup.form_wrapper.price_old_cleaner[/i18] [i18]tradeup.form_wrapper.required[/i18]!"
    }],
    contentId: [{
      required: true,
      msg: "[i18]tradeup.form_wrapper.uploadTips[/i18]"
    }]
  }
  const isRequired = (item) => {
    return item.some((item) => {
      return item.required
    })
  }
  const requiredIndex = (item) => {
    return item.findIndex((item) => {
      return item.required
    })
  }
  const isValidate = (item) => {
    return item.some((item) => {
      return item.validate
    })
  }
  const validateIndex = (item) => {
    return item.findIndex((item) => {
      return item.validate
    })
  }
  //表单字段验证
  const valueCheck = () => {
    let flag = true
    for (let key in fromRequired) {
      if (!formParams[key] && isRequired(fromRequired[key])) {
        const index = requiredIndex(fromRequired[key])
        //报错的input添加样式
        const input = $("input[name='" + key + "']")
        input.addClass("error")
        //视图滚动到报错的input
        $("html,body").animate({
          scrollTop: input.offset().top - 100
        }, 500)
        $(".fly-error-tip .text").text(fromRequired[key][index].msg)
        $(".fly-error-tip").show()
        setTimeout(function () {
          $(".fly-error-tip").hide()
          input.removeClass("error")
        }, 1314)
        flag = false
        break
      }
      if (formParams[key] && isValidate(fromRequired[key])) {
        const index = validateIndex(fromRequired[key])
        const input = $("input[name='" + key + "']")
        if (!fromRequired[key][index].validate(formParams[key])) {
          input.addClass("error")
          $(".fly-error-tip .text").text(fromRequired[key][index].msg)
          $(".fly-error-tip").show()
          setTimeout(function () {
            $(".fly-error-tip").hide()
            input.removeClass("error")
          }, 1314)
          flag = false
          break
        }
      }
    }
    return flag
  }
  //上传图片
  $(".fly-trade-up-form-h5 .fly-upload .f-input").change(function (e) {
    const file = e.target.files[0]
    if (!file) {
      //清除所选文件
      return
    }
    //上传小于10M的文件
    if (file.size > 10 * 1024 * 1024) {
      $(".max-sizeTip").show()
      setTimeout(function () {
        $(".max-sizeTip").hide()
      }, 2000)
      //错误提示
      $(".fly-error-tip .text").text("[i18]tradeup.form_wrapper.max[/i18]")
      $(".fly-error-tip").show()
      setTimeout(function () {
        $(".fly-error-tip").hide()
      }, 2000)
      return
    }
    //判断是否是图片类型还是PDF类型
    const isImage = file.type.indexOf("image") >= 0
    const isPdf = file.type.indexOf("pdf") >= 0
    if (isImage || isPdf) {
      const formData = new FormData()
      formData.append("file", file)
      //显示上传中
      $(".upload-animation").removeClass("hide")
      $("body").css("overflow", "hidden")
      $.ajax({
        url: "https://" + baseUrl + "/mapi/m/siteapi/saveUploadPrefixFile",
        type: "post",
        data: formData,
        processData: false,
        contentType: false,
        success: function (res) {
          $(".upload-animation").addClass("hide")
          $("body").css("overflow", "auto")
          const reader = new FileReader()
          reader.readAsDataURL(file)
          reader.onload = function (e) {
            const img = new Image()
            if (isImage) {
              img.src = e.target.result
            } else {
              img.src = "https://static-ussite.tineco.com/095d9ffb-08e3-4f52-be9b-ec5819db9a18.webp_d2bea963-c.webp"
            }
            imgArrStr.push(res.contentId)
            //图片最大5张
            if (imgArrStr.length === 5) {
              $(".fly-upload").hide()
            }
            img.onload = function () {
              const imgBox = $(".fly-trade-up-form-h5 .img-box")
              const img = $("<img>")
              const close = $("<div class='close-set'>x</div>")
              if (isImage) {
                img.attr("src", e.target.result)
              } else {
                img.attr("src", "https://static-ussite.tineco.com/095d9ffb-08e3-4f52-be9b-ec5819db9a18.webp_d2bea963-c.webp")
              }
              const imgItem = $("<div class='img-item'></div>")
              imgItem.append(img)
              imgItem.append(close)
              imgBox.append(imgItem)
              close.click(function () {
                imgItem.remove()
                imgArrStr.splice(imgArrStr.indexOf(res.contentId), 1)
                if (imgArrStr.length < 5) {
                  $(".fly-upload").show()
                }
              })
            }
          }
        },
        error: function () {
          //错误提示
          $(".fly-error-tip .text").text("[i18]tradeup.form_wrapper.try[/i18]")
          $(".fly-error-tip").show()
          setTimeout(function () {
            $(".fly-error-tip").hide()
          }, 2000)
        }
      })
    } else {
      //错误提示
      $(".fly-error-tip .text").text("[i18]tradeup.form_wrapper.only[/i18]")
      $(".fly-error-tip").show()
      setTimeout(function () {
        $(".fly-error-tip").hide()
      }, 2000)
    }
  })
  //提交表单
  $(".submitBtn").click(function () {
    //数据收集
    formParams.name = $("input[name='name']").val()
    formParams.email = $("input[name='email']").val()
    formParams.country = $(".down-menu .my-choose").text() === "[i18]tradeup.form_wrapper.country[/i18]*" ? "" : $(".down-menu .my-choose").text()
    formParams.brand = $("input[name='brand']").val()
    formParams.price = $("input[name='price']").val()
    formParams.contentId = imgArrStr.join(",")
    //数据验证
    if (!valueCheck()) {
      return
    }
    //提交表单
    $.ajax({
      url: "https://" + baseUrl + "/mapi/m/siteapi/savePromotionApply",
      type: "post",
      data: JSON.stringify(formParams),
      contentType: "application/json",
      success: function (res) {
        if (res.code === 0) {
          resetFormParams()
          //表单隐藏
          $(".fly-trade-up-form-h5 .form-content").hide()
          $(".success-tips").show()
        }
      }
    })
  })
  //封装一个弹窗，点击展示按钮，弹窗展示
  let isShow = false
  let isShowImg = false

  function showPopup() {
    if (!isShow) {
      $(".fly-pop").show()
      isShow = true
    }
  }

  //点击关闭按钮，弹窗关闭
  function closePopup() {
    $(".fly-pop").hide().remove()
    isShow = false
    isShowImg = false
  }

  $(".showPop").click(function () {
    //判断是否已经创建了弹窗
    if ($(".fly-pop").length > 0) {
      showPopup()
      return
    }
    //创建一个弹窗
    const pop = $("<div class='fly-pop'></div>")
    const close = $("<div class='fly-close'>x</div>")
    close.click(function () {
      event.stopPropagation()
      closePopup()
      $("body").css("overflow", "auto")
    })
    const content = $("<div class='content'></div>")
    content.append(close)

    content.append("<div class='title'><div>[i18]tradeup.form_wrapper.modal_title[/i18]</div></div>")
    content.append("<div class='img-box'>" +
      "<div class='item'><div class='text'>[i18]tradeup.form_wrapper.invoice[/i18]</div><div class='e-img'><img src='https://static-ussite.tineco.com/%E7%A4%BA%E4%BE%8B1.png_918cc291-1.png' alt=''></div></div>" +
      "<div class='item'><div class='text'>[i18]tradeup.form_wrapper.receipt[/i18]</div><div class='e-img'><img src='https://static-ussite.tineco.com/%E7%A4%BA%E4%BE%8B2.png_230fdb02-f.png' alt=''></div></div>" +
      "<div class='item'><div class='text'>[i18]tradeup.form_wrapper.photo[/i18]</div><div class='e-img'><img src='https://static-ussite.tineco.com/%E7%A4%BA%E4%BE%8B3.png_ea1c4ba4-1.png' alt=''></div></div>" +
      "</div>")

    pop.append(content)
    $("body").append(pop).css("overflow", "hidden")
    //图片点击放大
    $(".fly-pop .e-img").click(function () {
      event.stopPropagation()
      //当前图片的index
      const index = $(this).parent().index()
      //获取当前
      if (!isShowImg) {
        const imgContent = $("<div class='img-content'><div class='img-content-close'>X</div><div class='swiper-wrapper'>" +
          "<div class='swiper-slide'><img src='https://static-ussite.tineco.com/%E7%A4%BA%E4%BE%8B1.png_918cc291-1.png' alt=''></div>" +
          "<div class='swiper-slide'><img src='https://static-ussite.tineco.com/%E7%A4%BA%E4%BE%8B2.png_230fdb02-f.png' alt=''></div>" +
          "<div class='swiper-slide'><img src='https://static-ussite.tineco.com/%E7%A4%BA%E4%BE%8B3.png_ea1c4ba4-1.png' alt=''></div>" +
          "</div>" +
          "<div class='swiper-pagination'></div>" +
          "</div>")
        setTimeout(function () {
          $(".fly-pop").append(imgContent)
          //初始化swiper 传入当前图片的index
          const swiper = new Swiper('.img-content', {
            loop: true,
            pagination: {
              el: '.swiper-pagination',
            },
            initialSlide: index
          })
          isShowImg = true
          $(".img-content-close").click(function () {
            event.stopPropagation()
            $(".img-content").remove()
            isShowImg = false
          })
        })
      }
    })
    //禁止滚动
    showPopup()
  })
})
</script>
